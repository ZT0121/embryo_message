<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è½‰å…¥ï½œè¼¸å‡º å›å ±è¨Šæ¯ç”¢ç”Ÿå™¨</title>
<link rel="icon" href="./favicon.png">
<style>
:root{--ink:#e5e7eb;--muted:#94a3b8;--line:#223054;--bg:#0b1020;--card:#0c1428;--focus:#3356a7;--btn:#2a4aa1;--btn2:#203a83;--ok:#0f7036;--warn:#8c6307}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1020,#0b1328 40%,#0e1630);min-height:100%;color:var(--ink);font-family:'Noto Sans TC',system-ui}
header{position:sticky;top:0;background:rgba(11,16,32,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.h-inner{max-width:1000px;margin:auto;display:flex;align-items:center;gap:10px;padding:12px 16px}
.logo{width:28px;height:28px;border-radius:6px;background:#1e293b url('./favicon.png') center/cover no-repeat;border:1px solid #334155}
h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
main{max-width:1000px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:1024px){main{grid-template-columns:260px 1fr;gap:16px}}
.nav{background:linear-gradient(180deg,#0c1428,#0a1020);border:1px solid var(--line);border-radius:16px;padding:10px}
.tab{display:block;width:100%;text-align:left;border:1px solid var(--line);background:#0b152b;color:var(--ink);padding:12px 14px;border-radius:12px;margin:8px 0;font-weight:700;cursor:pointer}
.tab.active{outline:2px solid var(--focus);border-color:var(--focus);background:linear-gradient(180deg,#13244a,#0e1b3c)}
.panel{display:none}.panel.active{display:block}
.card{background:linear-gradient(180deg,#0c1428,#0a1020);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03)}
.section{padding:16px}.section+.section{border-top:1px dashed var(--line)}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.grid{grid-template-columns:repeat(12,1fr)}}
.col-3{grid-column:span 12}@media(min-width:900px){.col-3{grid-column:span 3}}
.col-4{grid-column:span 12}@media(min-width:900px){.col-4{grid-column:span 4}}
.col-5{grid-column:span 12}@media(min-width:900px){.col-5{grid-column:span 5}}
.col-6{grid-column:span 12}@media(min-width:900px){.col-6{grid-column:span 6}}
.col-7{grid-column:span 12}@media(min-width:900px){.col-7{grid-column:span 7}}
.col-12{grid-column:span 12}
label{display:block;font-size:13px;color:#cbd5e1;margin:2px 2px 6px}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b152b;color:var(--ink);outline:2px solid transparent;outline-offset:2px;transition:outline .15s,border .15s}
input:focus,select:focus,textarea:focus{outline:2px solid var(--focus);border-color:var(--focus)}
.small{font-size:12px;color:#94a3b8}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid #2c4690;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .06s,box-shadow .15s;box-shadow:0 6px 18px rgba(32,66,140,.35),inset 0 1px 0 rgba(255,255,255,.06)}
.btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(0)}
.btn.ok{background:linear-gradient(180deg,#188d46,var(--ok));border-color:#198045}
.btn.warn{background:linear-gradient(180deg,#b07a0b,var(--warn));border-color:#a27409}
.output{min-height:160px;white-space:pre-wrap;background:#0a1226;border:1px dashed #25407f;border-radius:14px;padding:14px;color:var(--ink)}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);border:none;margin:10px 0}
.badge{font-size:12px;color:#cbd5e1;background:#0f1a33;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{padding:8px;border:1px solid #223054;background:#0b152b}
.table th{background:#0e1b3c;font-size:12px;color:#cbd5e1}
.table td input{width:100%;padding:8px;border-radius:8px;border:1px solid #223054;background:#0b152b;color:#e5e7eb}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<header>
  <div class="h-inner">
    <div class="logo" aria-hidden="true"></div>
    <h1>è½‰å…¥ï½œè¼¸å‡º å›å ±è¨Šæ¯ç”¢ç”Ÿå™¨</h1>
    <span class="badge">é†«å¸«èˆ‡ç—…äººè¨Šæ¯æ¨¡æ¿</span>
  </div>
</header>

<main>
  <nav class="nav">
    <button class="tab active" data-target="panel-doctor">â‘  é†«å¸«é€šçŸ¥</button>
    <button class="tab" data-target="panel-patient">â‘¡ ç—…äººé€šçŸ¥</button>
  </nav>

  <section>
    <!-- é†«å¸«é€šçŸ¥ -->
    <div class="panel active" id="panel-doctor">
      <div class="card">
        <div class="section">
          <div class="grid">
            <div class="col-4">
              <label>æ¨¡æ¿</label>
              <select id="tplDoc">
                <option value="doc_single">(é†«å¸«) å®Œæˆè½‰ç§»é€šçŸ¥ï½œå–®ç­†</option>
                <option value="doc_group">(é†«å¸«) åœ˜é«”è½‰å…¥å®Œæˆï½œå¤šç­†</option>
              </select>
            </div>
            <div class="col-4">
              <label>è½‰å…¥ç¨®é¡</label>
              <select id="docType">
                <option value="èƒšèƒ">èƒšèƒ</option>
                <option value="åµå­">åµå­</option>
                <option value="å‡ç²¾">å‡ç²¾</option>
              </select>
            </div>
            <div class="col-4">
              <label>å°è±¡é†«å¸«ç¨±å‘¼ <button id="btnRoster" type="button" class="btn" style="margin-left:6px;padding:4px 8px">åå†Š</button></label>
              <input id="doctorName" placeholder="ä¾‹ï¼šé™³é†«å¸«" list="doctorList">
              <datalist id="doctorList"></datalist>
            </div>

            <!-- å–®ç­†ï¼šåˆ†æ¬„ -->
            <div class="col-4 only doc_single">
              <label>ç—…æ­·è™Ÿ</label>
              <input id="caseNo" placeholder="12345">
            </div>
            <div class="col-4 only doc_single">
              <label>å§“å</label>
              <input id="caseName" placeholder="ç‹å°æ˜">
            </div>
            <div class="col-4 only doc_single"></div>

            <!-- å¤šç­†ï¼šè¡¨æ ¼ -->
            <div class="col-12 only doc_group">
              <label>å¤šç­†å€‹æ¡ˆï¼ˆç—…æ­·è™Ÿï¼‹å§“åï¼‰</label>
              <table class="table" id="groupTable">
                <thead>
                  <tr><th style="width:30%">ç—…æ­·è™Ÿ</th><th style="width:50%">å§“å</th><th style="width:20%">æ“ä½œ</th></tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="row">
                <button class="btn" id="addRow">æ–°å¢ä¸€åˆ—</button>
                <button class="btn warn" id="clearRows">æ¸…ç©ºè¡¨æ ¼</button>
              </div>
            </div>

            <div class="col-12">
              <div class="row">
                <button class="btn" id="genDoc">ç”¢ç”Ÿè¨Šæ¯</button>
                <button class="btn ok" id="copyDoc">è¤‡è£½</button>
                <button class="btn" id="saveDoc">å­˜å…¥æ­·å²</button>
                <button class="btn warn" id="clearDoc">æ¸…ç©º</button>
              </div>
            </div>

            <div class="col-12">
              <div class="hr"></div>
              <div id="outDoc" class="output mono"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <strong>æ­·å²ç´€éŒ„ï¼ˆé†«å¸«é€šçŸ¥ï¼‰</strong>
          <div id="histDoc" class="hist"></div>
        </div>
      </div>
    </div>

    <!-- ç—…äººé€šçŸ¥ -->
    <div class="panel" id="panel-patient">
      <div class="card">
        <div class="section">
          <div class="grid">
            <div class="col-4">
              <label>æ¨¡æ¿</label>
              <select id="tplPt">
                <option value="pt_import">(å¯¦é©—å®¤)é€šçŸ¥è½‰èƒšå®Œæˆ</option>
                <option value="pt_export">(å¯¦é©—å®¤)é€šçŸ¥è¼¸å‡ºå·²å®Œæˆæé ˜</option>
              </select>
            </div>
            <div class="col-4">
              <label>ç—…äººç¨±å‘¼</label>
              <input id="ptName" placeholder="ä¾‹ï¼šåå­— / æå°å§">
            </div>
            <div class="col-4">
              <label>é¡å‹</label>
              <select id="ptType">
                <option value="åµå­">åµå­</option>
                <option value="èƒšèƒ">èƒšèƒ</option>
                <option value="å‡ç²¾">å‡ç²¾</option>
              </select>
            </div>

            <div class="col-12">
              <div class="row">
                <button class="btn" id="genPt">ç”¢ç”Ÿè¨Šæ¯</button>
                <button class="btn ok" id="copyPt">è¤‡è£½</button>
                <button class="btn" id="savePt">å­˜å…¥æ­·å²</button>
                <button class="btn warn" id="clearPt">æ¸…ç©º</button>
              </div>
            </div>
            <div class="col-12">
              <div class="hr"></div>
              <div id="outPt" class="output mono"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <strong>æ­·å²ç´€éŒ„ï¼ˆç—…äººé€šçŸ¥ï¼‰</strong>
          <div id="histPt" class="hist"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- åå†Šè¨­å®š -->
<div id="rosterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center">
  <div style="width:min(680px,92vw);background:#0c1428;border:1px solid #223054;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.5);padding:16px">
    <h3 style="margin:0 0 8px 0;font-size:16px">é†«å¸«åå†Š</h3>
    <div class="small" style="margin-bottom:8px">ä¸€è¡Œä¸€ä½é†«å¸«ï¼Œå¯è‡ªç”±ä¿®æ”¹ã€‚</div>
    <textarea id="rosterText" rows="10" style="width:100%;padding:10px;border-radius:10px;border:1px solid #223054;background:#0b152b;color:#e5e7eb"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="saveRoster" class="btn ok">å„²å­˜</button>
      <button id="clearRoster" class="btn warn">æ¸…ç©º</button>
      <button id="closeRoster" class="btn">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
/* ===== å·¥å…· ===== */
const $=id=>document.getElementById(id);
function toast(msg){const t=document.createElement('div');t.textContent=msg;Object.assign(t.style,{position:'fixed',left:'50%',top:'16px',transform:'translateX(-50%)',background:'#0f7036',border:'1px solid #198045',padding:'10px 14px',color:'#fff',borderRadius:'10px',zIndex:9999,boxShadow:'0 8px 24px rgba(0,0,0,.35)'});document.body.appendChild(t);setTimeout(()=>t.remove(),1100)}

/* ===== å·¦å´åˆ†é  ===== */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    $(btn.dataset.target).classList.add('active');
  };
});

/* ===== é†«å¸«åå†Šï¼ˆlocalStorageï¼‰ ===== */
(function initDefaultRoster(){
  const KEY='NUWA_DOCTOR_ROSTER';
  if(!localStorage.getItem(KEY)){
    const list=["é™³é†«å¸«","å»–é†«å¸«","æ²ˆé†«å¸«","è©¹é†«å¸«","å¼µé†«å¸«","ç‹é†«å¸«","æ—é†«å¸«","åŠ‰é†«å¸«","æœ±é†«å¸«","å³é†«å¸«","ä½•é†«å¸«","æ´ªé†«å¸«","æé†«å¸«"];
    localStorage.setItem(KEY, JSON.stringify(list));
  }
})();
const STORAGE_ROSTER='NUWA_DOCTOR_ROSTER';
const STORAGE_RECENT='NUWA_DOCTOR_RECENT';
function loadRoster(){try{return JSON.parse(localStorage.getItem(STORAGE_ROSTER)||'[]')}catch{return[]}}
function saveRoster(list){localStorage.setItem(STORAGE_ROSTER, JSON.stringify(list))}
function loadRecent(){try{return JSON.parse(localStorage.getItem(STORAGE_RECENT)||'[]')}catch{return[]}}
function pushRecent(name){if(!name)return;const list=loadRecent().filter(x=>x!==name);list.unshift(name);if(list.length>12)list.length=12;localStorage.setItem(STORAGE_RECENT, JSON.stringify(list))}
function refreshDoctorOptions(){
  const dl=$('doctorList');if(!dl)return;
  const roster=loadRoster(),recent=loadRecent(),seen=new Set();
  const order=[...recent,...roster].filter(Boolean).filter(n=>{if(seen.has(n))return false;seen.add(n);return true});
  dl.innerHTML=''; order.forEach(n=>{const opt=document.createElement('option');opt.value=n;dl.appendChild(opt);});
}
(function setupRosterUI(){
  const btn=$('btnRoster'),modal=$('rosterModal'),txt=$('rosterText');
  $('closeRoster').onclick=()=>modal.style.display='none';
  btn.onclick=()=>{txt.value=loadRoster().join('\n');modal.style.display='flex';};
  $('saveRoster').onclick=()=>{const lines=txt.value.split('\n').map(s=>s.trim()).filter(Boolean);const uniq=[...new Set(lines)];saveRoster(uniq);refreshDoctorOptions();toast('åå†Šå·²å„²å­˜')};
  $('clearRoster').onclick=()=>{saveRoster([]);txt.value='';refreshDoctorOptions();toast('åå†Šå·²æ¸…ç©º')};
  refreshDoctorOptions();
})();

/* ===== ç—…æ­·è™Ÿï¼šè‡ªå‹• # å‰ç¶´ ===== */
function withHash(v){v=String(v||'').trim(); if(!v) return ''; return v.startsWith('#')?v:'#'+v;}
function bindHashInput(input){
  if(!input) return;
  input.addEventListener('blur',()=>{input.value=withHash(input.value.replace(/\s+/g,''))});
  input.addEventListener('input',()=>{ if(/^#?\d*$/.test(input.value)) return; input.value=input.value.replace(/[^#\d]/g,''); });
}

/* ===== é†«å¸«ï¼šå¤šç­†è¡¨æ ¼ ===== */
const groupTableBody = document.querySelector('#groupTable tbody');
function addRow(no='',name=''){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="no" placeholder="12345" value="${no?String(no).replace(/^#/,''):''}"></td>
                <td><input class="nm" placeholder="ç‹å°æ˜" value="${name||''}"></td>
                <td><button class="btn warn del">åˆªé™¤</button></td>`;
  groupTableBody.appendChild(tr);
  const noInput=tr.querySelector('.no'); bindHashInput(noInput);
  tr.querySelector('.del').onclick=()=>tr.remove();
}
$('addRow').onclick=()=>addRow();
$('clearRows').onclick=()=>{groupTableBody.innerHTML='';};
addRow(); addRow();

/* ===== é†«å¸«ï¼šå–®ç­†æ¬„ä½ ===== */
bindHashInput($('caseNo'));

/* ===== é†«å¸«ï¼šç”¢ç”Ÿ/è¤‡è£½/æ­·å² ===== */
const D={
  tpl:$('tplDoc'), type:$('docType'), doctor:$('doctorName'),
  caseNo:$('caseNo'), caseName:$('caseName'),
  out:$('outDoc'), gen:$('genDoc'), copy:$('copyDoc'), save:$('saveDoc'), clear:$('clearDoc'),
  hist:$('histDoc')
};
const STORAGE_D='NUWA_DOC_HISTORY_v2';

function buildDocSingle(){
  const doctor=(D.doctor.value||'Oé†«å¸«').trim();
  const no=withHash(D.caseNo.value);
  const name=(D.caseName.value||'å§“å').trim();
  const t=D.type.value;
  return `${doctor}ï¼Œåˆå®‰
é€šçŸ¥æ‚¨ï¼Œ${no} ${name} çš„${t}å·²å®Œæˆè½‰å…¥å¯¦é©—å®¤ä½œæ¥­ï¼Œè¬è¬æ‚¨ã€‚`;
}
function buildDocGroup(){
  const doctor=(D.doctor.value||'Oé†«å¸«').trim();
  const t=D.type.value;
  const rows=[...groupTableBody.querySelectorAll('tr')].map(tr=>{
    const no=withHash(tr.querySelector('.no').value);
    const nm=(tr.querySelector('.nm').value||'å§“å').trim();
    if(!no && !nm) return '';
    return `${no||'#?????'} ${nm}`;
  }).filter(Boolean);
  const list=rows.length?rows.join('\n'):'#12345 å§“å\n#23456 å§“å';
  return `${doctor}æ‚¨å¥½ï¼Œä»Šæ—¥å·²é †åˆ©å®Œæˆ${t}è½‰ç§»çš„å€‹æ¡ˆæœ‰ï¼š
${list}

è¬è¬æ‚¨ğŸ™`;
}
function buildDoc(){ return D.tpl.value==='doc_single' ? buildDocSingle() : buildDocGroup(); }

function copyText(el){const t=el.textContent.trim(); if(!t) return; navigator.clipboard.writeText(t).then(()=>toast('å·²è¤‡è£½'));}
function saveDoc(){
  const payload={
    ts:Date.now(), tpl:D.tpl.value, type:D.type.value, doctor:D.doctor.value,
    single:{no:D.caseNo.value, name:D.caseName.value},
    group:[...groupTableBody.querySelectorAll('tr')].map(tr=>({no:tr.querySelector('.no').value, name:tr.querySelector('.nm').value})),
    out:D.out.textContent.trim()
  };
  if(!payload.out) return;
  const list=JSON.parse(localStorage.getItem(STORAGE_D)||'[]'); list.unshift(payload); if(list.length>80) list.length=80;
  localStorage.setItem(STORAGE_D, JSON.stringify(list)); renderDocHist(); toast('å·²å­˜å…¥æ­·å²');
}
function renderDocHist(){
  const list=JSON.parse(localStorage.getItem(STORAGE_D)||'[]'); D.hist.innerHTML='';
  if(!list.length){D.hist.innerHTML='<div class="small">å°šç„¡ç´€éŒ„</div>';return;}
  for(const it of list){
    const d=new Date(it.ts); const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const wrap=document.createElement('div'); wrap.className='item'; wrap.style.border='1px solid #223054'; wrap.style.borderRadius='12px'; wrap.style.padding='10px'; wrap.style.background='#0b152b';
    const top=document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.gap='8px'; top.style.alignItems='center';
    const meta=document.createElement('div'); meta.className='small'; meta.textContent=`${ds} Â· ${(it.tpl==='doc_single'?'é†«å¸«Â·å–®ç­†':'é†«å¸«Â·åœ˜é«”')} Â· ${it.type||''}`;
    const actions=document.createElement('div'); actions.className='row';
    const b1=document.createElement('button'); b1.className='btn'; b1.textContent='å¡«å›è¡¨å–®';
    b1.onclick=()=>{
      D.tpl.value=it.tpl; D.type.value=it.type||'èƒšèƒ'; D.doctor.value=it.doctor||'';
      if(it.tpl==='doc_single'){
        $('caseNo').value=it.single?.no||''; $('caseName').value=it.single?.name||'';
      }else{
        groupTableBody.innerHTML=''; (it.group||[]).forEach(r=>addRow(r.no, r.name)); if(!(it.group||[]).length) addRow();
      }
      D.out.textContent=it.out||''; scrollTo({top:0,behavior:'smooth'});
    };
    const b2=document.createElement('button'); b2.className='btn'; b2.textContent='è¤‡è£½ç”¢å‡º';
    b2.onclick=()=>{navigator.clipboard.writeText(it.out||'').then(()=>toast('å·²è¤‡è£½'));};
    const b3=document.createElement('button'); b3.className='btn warn'; b3.textContent='åˆªé™¤';
    b3.onclick=()=>{const l=(JSON.parse(localStorage.getItem(STORAGE_D)||'[]')).filter(x=>x.ts!==it.ts); localStorage.setItem(STORAGE_D, JSON.stringify(l)); renderDocHist();};
    actions.append(b1,b2,b3); top.append(meta,actions);
    const pre=document.createElement('pre'); pre.className='mono'; pre.style.margin='6px 0 0 0'; pre.textContent=it.out||'';
    wrap.append(top,pre); D.hist.append(wrap);
  }
}
renderDocHist();

D.gen.onclick=()=>{D.out.textContent=buildDoc(); pushRecent(D.doctor.value.trim()); refreshDoctorOptions();};
D.copy.onclick=()=>copyText(D.out);
D.save.onclick=saveDoc;
D.clear.onclick=()=>{
  ['doctor','caseNo','caseName'].forEach(k=>{const el=$(k); if(el) el.value='';});
  groupTableBody.innerHTML=''; addRow(); addRow();
  D.out.textContent=''; toast('å·²æ¸…ç©º');
};
$('tplDoc').addEventListener('change',()=>{
  document.querySelectorAll('.only').forEach(n=>n.style.display='none');
  document.querySelectorAll('.only.'+D.tpl.value).forEach(n=>n.style.display='');
});

/* ===== ç—…äººé€šçŸ¥ ===== */
const P={tpl:$('tplPt'),name:$('ptName'),type:$('ptType'),
  out:$('outPt'),gen:$('genPt'),copy:$('copyPt'),save:$('savePt'),clear:$('clearPt'),hist:$('histPt')};
const STORAGE_P='NUWA_PT_HISTORY_v2';

function buildPt(){
  const name=(P.name.value||'åå­—').trim();
  const type=P.type.value;
  if(P.tpl.value==='pt_import'){
    return `${name} æ‚¨å¥½ï¼Œ
æ‚¨çš„ ${type} å·²æ–¼ä»Šæ—¥é †åˆ©è½‰å…¥ ç¦¾é¦¨å®œè˜Šç”Ÿæ®–ä¸­å¿ƒï¼ˆå°åŒ—é™¢å€ï¼‰ã€‚
ç›¸é—œè©³ç´°è³‡è¨Šå¯é€é App æŸ¥è©¢ã€‚
æ­¤è¨Šæ¯ä»¥ LINE å‚³é€ï¼Œæ–¹ä¾¿æ‚¨å¾ŒçºŒç™‚ç¨‹çš„å®‰æ’ï¼Œè¬è¬æ‚¨ã€‚`;
  }
  return `${name} æ‚¨å¥½ï¼Œé€šçŸ¥æ‚¨çš„ ${type} å·²ç¶“å®Œæˆæé ˜é€²è¡Œé‹è¼¸ï¼Œè¬è¬æ‚¨ã€‚`;
}
function savePt(){
  const out=P.out.textContent.trim(); if(!out) return;
  const item={ts:Date.now(),tpl:P.tpl.value,name:P.name.value,type:P.type.value,out};
  const list=JSON.parse(localStorage.getItem(STORAGE_P)||'[]'); list.unshift(item); if(list.length>80) list.length=80;
  localStorage.setItem(STORAGE_P, JSON.stringify(list)); renderPtHist(); toast('å·²å­˜å…¥æ­·å²');
}
function renderPtHist(){
  const list=JSON.parse(localStorage.getItem(STORAGE_P)||'[]'); P.hist.innerHTML='';
  if(!list.length){P.hist.innerHTML='<div class="small">å°šç„¡ç´€éŒ„</div>';return;}
  for(const it of list){
    const d=new Date(it.ts); const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const wrap=document.createElement('div'); wrap.className='item'; wrap.style.border='1px solid #223054'; wrap.style.borderRadius='12px'; wrap.style.padding='10px'; wrap.style.background='#0b152b';
    const top=document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.gap='8px'; top.style.alignItems='center';
    const meta=document.createElement('div'); meta.className='small'; const map={pt_import:'ç—…äººÂ·è½‰èƒšå®Œæˆ',pt_export:'ç—…äººÂ·è¼¸å‡ºæé ˜'}; meta.textContent=`${ds} Â· ${map[it.tpl]||it.tpl}`;
    const actions=document.createElement('div'); actions.className='row';
    const b1=document.createElement('button'); b1.className='btn'; b1.textContent='å¡«å›è¡¨å–®';
    b1.onclick=()=>{P.tpl.value=it.tpl; P.name.value=it.name||''; P.type.value=it.type||'åµå­'; P.out.textContent=it.out||''; scrollTo({top:0,behavior:'smooth'});}
    const b2=document.createElement('button'); b2.className='btn'; b2.textContent='è¤‡è£½ç”¢å‡º';
    b2.onclick=()=>{navigator.clipboard.writeText(it.out||'').then(()=>toast('å·²è¤‡è£½'));};
    const b3=document.createElement('button'); b3.className='btn warn'; b3.textContent='åˆªé™¤';
    b3.onclick=()=>{const l=(JSON.parse(localStorage.getItem(STORAGE_P)||'[]')).filter(x=>x.ts!==it.ts); localStorage.setItem(STORAGE_P, JSON.stringify(l)); renderPtHist();};
    actions.append(b1,b2,b3); top.append(meta,actions);
    const pre=document.createElement('pre'); pre.className='mono'; pre.style.margin='6px 0 0 0'; pre.textContent=it.out||'';
    wrap.append(top,pre); P.hist.append(wrap);
  }
}
renderPtHist();

P.gen.onclick=()=>{P.out.textContent=buildPt();};
P.copy.onclick=()=>{const t=P.out.textContent.trim(); if(!t) return; navigator.clipboard.writeText(t).then(()=>toast('å·²è¤‡è£½'));};
P.save.onclick=savePt;
P.clear.onclick=()=>{['ptName'].forEach(k=>{const el=$(k); if(el) el.value='';}); P.type.value='åµå­'; P.out.textContent=''; toast('å·²æ¸…ç©º');};

/* ===== å¿«æ·éµ ===== */
document.addEventListener('keydown',(e)=>{
  const isMac=navigator.platform.toUpperCase().includes('MAC');
  const meta=isMac?e.metaKey:e.ctrlKey;
  if(meta && e.key==='Enter'){
    e.preventDefault();
    if($('panel-doctor').classList.contains('active')) $('genDoc').click();
    else $('genPt').click();
  }
  if(meta && e.key.toLowerCase()==='c' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)){
    e.preventDefault();
    if($('panel-doctor').classList.contains('active')) $('copyDoc').click();
    else $('copyPt').click();
  }
});
</script>
</body>
</html>

<!-- sperm.htmlï¼ˆå·²æ•´åˆï¼šä¿®æ”¹æ—¥æœŸ + æ­·å²æ”¶åˆ + å…±ç”¨ ui_common_v4.js + æ­·å²å­—é«”ä¸€è‡´ï¼‰ -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="icon" type="image/png" href="sperm.png" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‡ç²¾è¨Šæ¯ç”¢ç”Ÿå™¨</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fdfaf7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MessageHub">
  <link rel="apple-touch-icon" href="icon-512.png">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>

  <style>
    body {
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
      font-size: 13px;
      background-color: #fdfaf7;
      color: #4b3b30;
      margin: 0;
      padding: 1.5rem 1rem;
      line-height: 1.5;
    }

    .container { max-width: 600px; margin: 0 auto; }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #5e473a;
      font-weight: 800;
      font-size: 1.8rem;
      letter-spacing: 1px;
    }

    .nav {
      text-align: center;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background-color: #fcefe6;
      color: #8c6b5d;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 13px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-btn:hover {
      background-color: #f3d7c3;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
      font-weight: 700;
      color: #6d5648;
      font-size: 13px;
    }

    input, select {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 0.4rem;
      border: 1px solid #eee5dd;
      font-size: 13px;
      background-color: #fff;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #d8c3a5;
      box-shadow: 0 0 0 3px rgba(216, 195, 165, 0.3);
    }

    .data-group {
      background-color: #fff;
      border: 1px solid #eee;
      padding: 1rem;
      border-radius: 0.6rem;
      margin-top: 0.8rem;
    }

    .data-group h3 {
      margin-top: 0;
      font-size: 14px;
      color: #8c6b5d;
      border-bottom: 2px solid #f3d7c3;
      padding-bottom: 0.4rem;
      margin-bottom: 0.8rem;
    }

    .btn-group {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.2rem;
    }

    button {
      flex: 1;
      background-color: #d8c3a5;
      color: #4b3b30;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 0.4rem;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background-color: #cbb08e;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #output {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #e0d6cd;
      border-radius: 0.6rem;
      white-space: pre-wrap;
      font-size: 13px;
      color: #444;
    }

    /* æ­·å²å€å¡Š */
    #history {
      margin-top: 1rem;
      background-color: #f5eee6;
      padding: 1rem;
      border-radius: 0.6rem;
      border: 1px solid #e0d6cd;
    }

    .history-message {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
      font-size: 13px;
      color: #555;
    }

    #historyList {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-direction: column-reverse;
      gap: 0.8rem;
    }

    #historyList li {
      border: 1px solid #ddd;
      padding: 0.8rem;
      border-radius: 0.4rem;
      background-color: #fff8f0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .hidden { display: none !important; }
    .scenario-block { display: none; }

    /* æ­·å²æ¨™é¡Œï¼ˆè·Ÿ index åŒæ­¥ï¼‰ */
    .history-title {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #6d5648;
      text-align: center;
      margin: 0.2rem 0 0.6rem;
    }

    /* æ­·å²è¤‡è£½æŒ‰éˆ•ï¼ˆè·Ÿ index åŒæ­¥ï¼‰ */
    .history-copy-btn {
      align-self: flex-end;
      font-size: 12px;
      font-weight: 600;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: #e8d9c6;
      color: #5e473a;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      flex: none;
      width: auto;
    }

    .history-copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }

    @media (max-width: 480px) { h1 { font-size: 1.4rem; } }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ§ª å‡ç²¾è¨Šæ¯ç”¢ç”Ÿå™¨</h1>

  <div class="nav">
    <a href="index.html" class="nav-btn">ğŸ”™ å›å ±èƒš</a>
    <a href="rescueICSI.html" class="nav-btn">ğŸ§¬ è£œæ•‘å—ç²¾</a>
    <a href="transfer_message.html" class="nav-btn">ğŸ“¦ è½‰å…¥/è¼¸å‡º</a>
  </div>

  <label for="scenario">ğŸ“Œ é¸æ“‡ç‹€æ³</label>
  <select id="scenario" onchange="switchScenario()">
    <option value="">--- è«‹é¸æ“‡ ---</option>
    <option value="s1">å€‹æ¡ˆä¸åœ¨ç¾å ´ç­‰å€™</option>
    <option value="s2b">å€‹æ¡ˆåœ¨ç¾å ´ï¼ŒäºŒå–ä»ä¸ä½³</option>
  </select>

  <div style="display:flex; gap:1rem;">
    <div style="flex:1;">
      <label>ğŸ”¢ ç—…æ­·è™Ÿ</label>
      <input type="text" id="caseId" placeholder="12345">
    </div>
    <div style="flex:1;">
      <label>ğŸ‘¤ å§“å</label>
      <input type="text" id="caseName" placeholder=" ">
    </div>
  </div>

  <label for="doctor">ğŸ©º é¸æ“‡é†«å¸«</label>
  <select id="doctor">
    <option value="">--- è«‹é¸æ“‡ ---</option>
    <option value="é™³é†«å¸«">é™³é†«å¸«</option>
    <option value="å»–é™¢">å»–é™¢</option>
    <option value="è©¹é†«å¸«">è©¹é†«å¸«</option>
    <option value="æ²ˆé†«å¸«">æ²ˆé†«å¸«</option>
    <option value="å¼µé†«å¸«">å¼µé†«å¸«</option>
    <option value="åŠ‰é†«å¸«">åŠ‰é†«å¸«</option>
    <option value="æœ±é™¢">æœ±é™¢</option>
    <option value="ç‹é™¢">ç‹é™¢</option>
    <option value="æ—é†«å¸«">æ—é†«å¸«</option>
    <option value="æé†«å¸«">æé†«å¸«</option>
    <option value="ä½•é†«å¸«">ä½•é†«å¸«</option>
    <option value="æ´ªé†«å¸«">æ´ªé†«å¸«</option>
    <option value="è‡ªå¡«">å…¶ä»–ï¼ˆè‡ªå¡«ï¼‰</option>
  </select>
  <input type="text" id="doctorCustom" placeholder="è¼¸å…¥é†«å¸«å§“å" style="display:none; margin-top:0.5rem;">

  <div id="scenario1" class="scenario-block">
    <div class="data-group">
      <h3>ğŸ”¬ æª¢é«”æ•¸æ“š</h3>
      <label>Volume (ml)ï¼š<input type="number" id="volume1" step="0.1"></label>
      <label>Concentration (M)ï¼š<input type="number" id="conc1"></label>
      <label>PR (%)ï¼š<input type="number" id="PR1"></label>
      <label>â„ï¸ å†·å‡ç®¡æ•¸ï¼š<input type="number" id="tubes1"></label>
    </div>
    <div class="btn-group">
      <button onclick="generateDoctor1()">ğŸ©º ç”¢ç”Ÿé†«å¸«è¨Šæ¯</button>
      <button onclick="generatePatient1()" style="background-color: #e5c0a8;">ğŸ‘¤ ç”¢ç”Ÿå€‹æ¡ˆè¨Šæ¯</button>
    </div>
  </div>

  <div id="scenario2b" class="scenario-block">
    <div class="data-group">
      <h3>ğŸ”¬ ç¬¬ä¸€æ¬¡æª¢é«”</h3>
      <label>Volume (ml)ï¼š<input type="number" id="volume21" step="0.1"></label>
      <label>Concentration (M)ï¼š<input type="number" id="conc21"></label>
      <label>PR (%)ï¼š<input type="number" id="PR21"></label>
    </div>

    <div class="data-group">
      <h3>ğŸ”¬ ç¬¬äºŒæ¬¡æª¢é«”</h3>
      <label>Volume (ml)ï¼š<input type="number" id="volume22" step="0.1"></label>
      <label>Concentration (M)ï¼š<input type="number" id="conc22"></label>
      <label>PR (%)ï¼š<input type="number" id="PR22"></label>
    </div>

    <label>â„ï¸ å†·å‡ç®¡æ•¸ï¼š</label>
    <input type="number" id="tubes2">

    <div class="btn-group">
      <button onclick="generateDoctor2B()">ğŸ©º ç”¢ç”Ÿé†«å¸«è¨Šæ¯</button>
      <button onclick="generatePatient2B()" style="background-color: #e5c0a8;">ğŸ‘¤ ç”¢ç”Ÿå€‹æ¡ˆè¨Šæ¯</button>
    </div>
  </div>

  <button onclick="copyMessage()" style="margin-top: 1.5rem; background-color: #a5d8b9; color: #2d4b38; width:100%;">âœ… è¤‡è£½è¨Šæ¯</button>
  <div id="output"></div>

  <div id="versionInfo" style="font-size: 12px; color:#8c6b5d; text-align:center; margin: 0.6rem 0 0.3rem;"></div>

  <div id="history">
    <button id="toggleHistoryBtn" style="width:100%; margin-bottom:0.6rem; background-color:#f3e6da;">
      ğŸ“‚ é¡¯ç¤ºæ­·å²ç´€éŒ„
    </button>

    <div id="historyContent" class="hidden">
      <h2 class="history-title">â³ æ­·å²ç´€éŒ„</h2>
      <ul id="historyList"></ul>
      <button onclick="clearHistory()" style="margin-top: 0.8rem; background-color: #eee; width: 100%; color:#666; border:none; padding:0.6rem; border-radius:0.5rem; cursor:pointer;">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
    </div>
  </div>

  <textarea id="hiddenCopy" style="position:absolute; left:-9999px;"></textarea>
</div>

<!-- å…ˆè¼‰å…¥å…±ç”¨ UI -->
<script src="js/ui_common_v4.js?v=4.0.0"></script>

<script>
  const APP_VERSION = "v2.0ï½œ2025.12.31";
  let historyApi;

  window.addEventListener('load', () => {
    historyApi = initCommonUI({
      appVersion: APP_VERSION,
      storageKey: "history_sperm",
      dateElId: "__none__", // é€™é æ²’æœ‰ date
    });
    window.historyApi = historyApi;
  });

  document.getElementById("doctor").addEventListener("change", function() {
    let custom = document.getElementById("doctorCustom");
    custom.style.display = (this.value === "è‡ªå¡«") ? "block" : "none";
  });

  function switchScenario() {
    document.getElementById("scenario1").style.display = "none";
    document.getElementById("scenario2b").style.display = "none";
    let s = document.getElementById("scenario").value;
    if (s === "s1") document.getElementById("scenario1").style.display = "block";
    if (s === "s2b") document.getElementById("scenario2b").style.display = "block";
  }

  function generateDoctor1() {
    let caseId = document.getElementById("caseId").value.trim();
    let caseName = document.getElementById("caseName").value.trim();
    let doctor = document.getElementById("doctor").value;
    if (doctor === "è‡ªå¡«") doctor = document.getElementById("doctorCustom").value;

    let volume = parseFloat(document.getElementById("volume1").value);
    let conc = parseFloat(document.getElementById("conc1").value);
    let PR = parseFloat(document.getElementById("PR1").value);
    let tubes = document.getElementById("tubes1").value.trim();

    let abnormalities = [];
    if (!isNaN(volume) && volume < 1) abnormalities.push(`Volume: ${volume} ml`);
    if (!isNaN(conc) && conc < 15) abnormalities.push(`Concentration: ${conc} M`);
    if (!isNaN(PR) && PR < 30) abnormalities.push(`PR: ${PR}%`);

    if (abnormalities.length === 0) {
      displayAndSave("ï¼ˆæ•¸æ“šç„¡ç•°å¸¸ï¼Œä¸éœ€å‚³è¨Šæ¯ï¼‰");
      return;
    }

    let message = `${doctor}æ‚¨å¥½ï¼Œ\n\nä»Šæ—¥å‡ç²¾å€‹æ¡ˆ #${caseId} ${caseName}\næª¢é«”åˆ†æï¼š\n\n${abnormalities.join("\n")}\n\nç”±æ–¼å€‹æ¡ˆä»Šæ—¥ç„¡æ³•ç•™åœ¨ç¾å ´ç­‰å€™ï¼Œå¯¦é©—å®¤å·²å…ˆå°‡æ­¤æ¬¡ç²¾èŸ²å†·å‡ ${tubes} ç®¡ï¼Œ\nå»ºè­°å€‹æ¡ˆå¯ä»¥æ“‡æ—¥å†å†·å‡ï¼Œæˆ–è€…æ–¼å—ç²¾ç™‚ç¨‹ç•¶å¤©ä½¿ç”¨æ–°é®®ç²¾èŸ²å—ç²¾ã€‚\n`;
    displayAndSave(message);
  }

  function generatePatient1() {
    let caseName = document.getElementById("caseName").value.trim();
    let tubes = document.getElementById("tubes1").value.trim();
    let abnormalities = [];
    let volume = parseFloat(document.getElementById("volume1").value);
    let conc = parseFloat(document.getElementById("conc1").value);
    let PR = parseFloat(document.getElementById("PR1").value);
    if (!isNaN(volume) && volume < 1) abnormalities.push("é«”ç©ä¸è¶³");
    if (!isNaN(conc) && conc < 15) abnormalities.push("æ¿ƒåº¦åä½");
    if (!isNaN(PR) && PR < 30) abnormalities.push("æ´»å‹•åŠ›ä¸è¶³");

    let abnText = abnormalities.length > 0 ? `ï¼ˆ${abnormalities.join("ã€")}ï¼‰` : "";
    let message = `${caseName}æ‚¨å¥½ï¼Œ\n\nä»Šæ—¥æª¢é«”ç²¾èŸ²ç‹€æ³è¼ƒä¸ç†æƒ³${abnText}ã€‚\næˆ‘å€‘å·²å…ˆå°‡æ­¤æ¬¡ç²¾èŸ²å†·å‡ ${tubes} ç®¡ï¼Œ\nå»ºè­°æ‚¨å¯æ“‡æ—¥å®‰æ’å†æ¬¡å‡ç²¾ï¼Œæˆ–æ–¼å—ç²¾ç™‚ç¨‹ç•¶å¤©æä¾›æ–°é®®ç²¾æ¶²ã€‚\næ­¤æ¬¡å‡ç²¾çš„æª¢é©—å ±å‘Šå·²ä¸Šå‚³è‡³ APPï¼Œè‹¥æœ‰ç–‘å•ä¹Ÿå»ºè­°æ‚¨å›è¨ºèˆ‡é†«å¸«è«®è©¢ã€‚\nè¬è¬æ‚¨ã€‚`;
    displayAndSave(message);
  }

  function generateDoctor2B() {
    let caseId = document.getElementById("caseId").value.trim();
    let caseName = document.getElementById("caseName").value.trim();
    let doctor = document.getElementById("doctor").value;
    if (doctor === "è‡ªå¡«") doctor = document.getElementById("doctorCustom").value;

    let v1 = document.getElementById("volume21").value.trim();
    let c1 = document.getElementById("conc21").value.trim();
    let p1 = document.getElementById("PR21").value.trim();
    let v2 = document.getElementById("volume22").value.trim();
    let c2 = document.getElementById("conc22").value.trim();
    let p2 = document.getElementById("PR22").value.trim();
    let tubes = document.getElementById("tubes2").value.trim();

    let message = `${doctor}æ‚¨å¥½ï¼Œ\n\nä»Šæ—¥å‡ç²¾å€‹æ¡ˆ #${caseId} ${caseName}\næª¢é«”åˆ†æï¼š\n\nç¬¬ä¸€æ¬¡ï¼š\n  Volume: ${v1} ml\n  Concentration: ${c1} M\n  PR: ${p1}%\n\nç¬¬äºŒæ¬¡ï¼š\n  Volume: ${v2} ml\n  Concentration: ${c2} M\n  PR: ${p2}%\n\näºŒæ¬¡ç¹³äº¤å¾Œç²¾èŸ²ç‹€æ³ä»ä¸ä½³ï¼Œ\nå¯¦é©—å®¤å·²å…ˆå°‡æ­¤æ¬¡ç²¾èŸ²å†·å‡ ${tubes} ç®¡å‚™ç”¨ï¼Œ\nå»ºè­°å¯è«‹å€‹æ¡ˆæ“‡æ—¥å®‰æ’å†æ¬¡å‡ç²¾ï¼Œæˆ–æ–¼å—ç²¾ç™‚ç¨‹ç•¶å¤©ä½¿ç”¨æ–°é®®ç²¾èŸ²ã€‚`;
    displayAndSave(message);
  }

  function generatePatient2B() {
    let caseName = document.getElementById("caseName").value.trim();
    let tubes = document.getElementById("tubes2").value.trim();

    let abn = [];
    let c2 = parseFloat(document.getElementById("conc22").value);
    let p2 = parseFloat(document.getElementById("PR22").value);
    if (!isNaN(c2) && c2 < 15) abn.push("æ¿ƒåº¦åä½");
    if (!isNaN(p2) && p2 < 30) abn.push("æ´»å‹•åŠ›ä¸è¶³");
    let abnText = abn.length > 0 ? `ï¼ˆ${abn.join("ã€")}ï¼‰` : "";

    let message = `${caseName}æ‚¨å¥½ï¼Œ\n\nä»Šæ—¥æ‚¨æ–¼æœ¬é™¢ç¹³äº¤ 2 æ¬¡æª¢é«”ï¼Œç²¾èŸ²ç‹€æ³ä»ä¸ç†æƒ³${abnText}ã€‚\næˆ‘å€‘å·²å…ˆå°‡æ­¤æ¬¡ç²¾èŸ²å†·å‡ ${tubes} ç®¡å‚™ç”¨ï¼Œ\nå»ºè­°æ‚¨å¯æ“‡æ—¥å®‰æ’å†æ¬¡å‡ç²¾ï¼Œæˆ–æ–¼å—ç²¾ç™‚ç¨‹ç•¶å¤©æä¾›æ–°é®®ç²¾æ¶²ã€‚\næ­¤æ¬¡æª¢é©—å ±å‘Šå·²ä¸Šå‚³è‡³ APPï¼Œè‹¥æœ‰ç–‘å•ä¹Ÿå»ºè­°æ‚¨å›è¨ºèˆ‡é†«å¸«è«®è©¢ã€‚\nè¬è¬æ‚¨ã€‚`;
    displayAndSave(message);
  }

  function displayAndSave(msg) {
    document.getElementById("output").innerText = msg;
    if (window.historyApi) window.historyApi.addToHistory(msg);
  }

  function copyMessage() {
    let text = document.getElementById("output").innerText;
    if (!text || text.includes("ä¸éœ€å‚³è¨Šæ¯")) {
      alert("ç›®å‰æ²’æœ‰éœ€è¦è¤‡è£½çš„è¨Šæ¯");
      return;
    }
    const hidden = document.getElementById("hiddenCopy");
    hidden.value = text;
    hidden.select();
    document.execCommand("copy");
    hidden.blur();
    alert("è¨Šæ¯å·²è¤‡è£½");
  }

  function clearHistory() {
    if (window.historyApi) window.historyApi.clearHistory();
  }
</script>

</body>
</html>
